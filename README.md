# grafana-ntfy-cf-worker

A Cloudflare Worker that acts as a bridge between **Grafana Alerting **(built-in Alertmanager)** and **ntfy.sh**.
It exposes a secured webhook endpoint that Grafana calls whenever an alert transitions to **firing** or **resolved**, normalizes Grafana’s payload, and sends a formatted notification to an ntfy topic.

## Features

* **Bearer authentication** (required to call the worker)
* Accepts only **POST** requests
* Fixes invalid JSON generated by Grafana (Grafana escapes parentheses `\(` and `\)` which breaks JSON)
* Parses labels and annotations into usable objects
* Extracts:
  * alert status (firing / resolved)
  * alert name
  * summary / annotations
  * Dashboard URL
  * Silence URL
* Sends a Markdown ntfy notification with:
  * `red_circle` or `green_circle` tag
  * Optional actions:
    * “Dashboard”
    * “Silence alert”

Compatible with the **Grafana built-in Alertmanager**.

## Worker Code

The Worker expects two secrets:

* `AUTH_TOKEN` → the Bearer token also configured in Grafana
* `TOPIC` → the ntfy topic to publish notifications to

See below for deployment instructions.

## Deploying to Cloudflare Workers

1. Install Wrangler (if not already installed)

```bash
npm install -g wrangler
```

2. Deploy the worker

Inside your repository:

```bash
wrangler deploy
```

3. Set the required secrets

```bash
wrangler secret put AUTH_TOKEN
wrangler secret put TOPIC
```

You will be prompted for values.

## Grafana Configuration

Create a **Contact Point** of type **Webhook**.

Webhook settings

| Setting                  | Value                                           |
|--------------------------|-------------------------------------------------|
| HTTP Method              | `POST`                                          |
| URL                      | The Worker URL (e.g. `https://...workers.dev`) |
| Authorization Scheme     | `Bearer`                                        |
| Authorization Credentials| Same as `AUTH_TOKEN`                            |
| Custom Headers           | Leave empty                                     |
| Custom Payload           | JSON template below                             |

## Custom Payload

Use the following JSON template:

```json
{"receiver":"{{ .Receiver }}","status":"{{ .Status }}","alerts_firing":[{{ range .Alerts.Firing }}{"status":"{{ .Status }}","labels":"{{ .Labels }}","annotations":"{{ .Annotations }}","starts_at":"{{ .StartsAt }}","ends_at":"{{ .EndsAt }}","generator_url":"{{ .GeneratorURL }}","fingerprint":"{{ .Fingerprint }}","dashboard_url":"{{ .DashboardURL }}","panel_url":"{{ .PanelURL }}","silence_url":"{{ .SilenceURL }}","values":"{{ .Values }}","value_string":"{{ .ValueString }}"}{{ end }}],"alerts_resolved":[{{ range .Alerts.Resolved }}{"status":"{{ .Status }}","labels":"{{ .Labels }}","annotations":"{{ .Annotations }}","starts_at":"{{ .StartsAt }}","ends_at":"{{ .EndsAt }}","generator_url":"{{ .GeneratorURL }}","fingerprint":"{{ .Fingerprint }}","dashboard_url":"{{ .DashboardURL }}","panel_url":"{{ .PanelURL }}","silence_url":"{{ .SilenceURL }}","values":"{{ .Values }}","value_string":"{{ .ValueString }}"}{{ end }}],"group_labels":"{{ .GroupLabels }}","common_labels":"{{ .CommonLabels }}","common_annotations":"{{ .CommonAnnotations }}","external_url":"{{ .ExternalURL }}"}
```

This ensures Grafana sends both firing and resolved alerts.

## ntfy Message Format

Messages sent to ntfy include:

* **Title**: `Grafana alert (firing)` or `Grafana alert (resolved)`
* **Tags**:
  * `red_circle` (firing)
  * `green_circle` (resolved)

* **Body**:
`AlertName is firing (Summary...)`
* **Actions**:
  * Dashboard → opens the related panel/dashboard
  * Silence alert → opens Grafana’s silence creation UI

## Notes

* The Worker automatically fixes malformed payloads caused by Grafana escaping parentheses.
* Only the first alert in a batch is sent (Grafana typically groups them).
* For debugging, you can temporarily uncomment the `console.log("RAW BODY >>>", raw)` line.

## License

MIT
